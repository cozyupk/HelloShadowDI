<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!-- デフォルトの Impl プロジェクトを推定 -->
	<PropertyGroup>
		<!-- e.g., 01100_Contracts → 01200_Impl -->
		<RawName>$([System.String]::Copy($(MSBuildProjectName)))</RawName>
		<SectionId>$([System.Text.RegularExpressions.Regex]::Replace($(RawName), '100_Contracts', '200_Impl'))</SectionId>
		<ShadowImplProject>
			$(MSBuildProjectDirectory)\..\Impl\$(SectionId).csproj
		</ShadowImplProject>
	</PropertyGroup>

	<!-- Impl を先にビルド -->
	<Target Name="BuildShadowImpl" BeforeTargets="Build">
		<Message Text="🛠 ShadowDI: Building shadow project $(ShadowImplProject)" Importance="High" />
		<MSBuild Projects="$(ShadowImplProject)"
				 Targets="Build"
				 Properties="Configuration=$(Configuration);Platform=$(Platform)" />
	</Target>

	<Target Name="MarkRebuild" BeforeTargets="Rebuild">
		<WriteLinesToFile
			File="$(MSBuildProjectDirectory)\..\..\rebuild.marker"
			Lines="Rebuilt at $(MSBuildThisFileFullPath)"
			Overwrite="true" />
	</Target>

	<Target Name="MarkRebuild" AfterTargets="Rebuild">
		<Delete Files="$(MSBuildProjectDirectory)\..\..\rebuild.marker" />
	</Target>
	
	<!-- 依存DLLを OutputPath にコピー -->
	<Target Name="CopyShadowDependencies"
			AfterTargets="Build"
			DependsOnTargets="BuildShadowImpl">

		<ItemGroup>
			<ShadowDependencyPaths Include="$(MSBuildProjectDirectory)\..\Impl\bin\$(Configuration)\$(TargetFramework)\dependencies" />
		</ItemGroup>

		<!-- 2. そこから全ファイルを再帰取得 -->
		<CreateItem Include="@(ShadowDependencyPaths->'%(Identity)\**\*.*')">
			<Output TaskParameter="Include" ItemName="FilesToCopy" />
		</CreateItem>
		
		<Copy
		  SourceFiles="@(FilesToCopy)"
		  DestinationFiles="@(FilesToCopy->'$(OutputPath)\%(RecursiveDir)%(Filename)%(Extension)')"
		  SkipUnchangedFiles="true" />
	</Target>

</Project>