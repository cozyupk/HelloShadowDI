<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<Target Name="CopyShadowDependencies" DependsOnTargets="BuildShadowProjects" BeforeTargets="BeforeBuild">
		<!-- コピー元のファイル群（ワイルドカードOK！） -->
		<ItemGroup>
			<ShadowArtifacts Include="$(SolutionDir)_artifacts\$(Configuration)\deps\**\*" />
		</ItemGroup>

		<!-- コピー先（プロジェクトの出力フォルダ or 任意フォルダ） -->
		<Copy SourceFiles="@(ShadowArtifacts)" DestinationFolder="$(OutputPath)deps\%(RecursiveDir)" SkipUnchangedFiles="true" />

		<Message Importance="high" Text="Shadow: copied @(ShadowArtifacts-&gt;Count()) files to dependencies folder." />
	</Target>
	
	<Target Name="BuildShadowProjects" DependsOnTargets="ResolveShadowReferences">
		<Message Importance="high" Text="Shadow: building shadow projects..." />
		<MSBuild Projects="@(ProjectShadowReference->'%(ShadowPath)')" Targets="Build" BuildInParallel="true" ContinueOnError="false">
		</MSBuild>
	</Target>

	<Target Name="ResolveShadowReferences">
		<ItemGroup>
			<ProjectShadowReference Include="@(ProjectReference)">
				<ShadowPath>$([System.String]::Copy('%(FullPath)')
					        .Replace('\Contracts\', '\Impl\')
					        .Replace('100_Contracts', '200_Impl'))</ShadowPath>
			</ProjectShadowReference>
		</ItemGroup>

		<!-- 出力確認 -->
		<Message Importance="high" Text="Shadow: %(ProjectShadowReference.ShadowPath)" />
	</Target>

	<Target Name="CleanShadowDependencies" AfterTargets="Clean">
		<RemoveDir Directories="$(OutputPath)deps" />
		<Message Importance="high" Text="Shadow: removed $(OutputPath)deps directory." />
	</Target>
	
</Project>